<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AFIT Campus Navigator â€“ Login</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      .btn-primary {
        background-color: #003366;
        transition: background-color 0.3s ease, transform 0.2s ease;
      }
      .btn-primary:hover {
        background-color: #002244;
        transform: translateY(-2px);
      }
      .btn-primary:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.3);
      }
      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .error-message {
        transition: opacity 0.3s ease;
      }
      .error-message.hidden {
        opacity: 0;
        height: 0;
        margin: 0;
      }
      .error-message:not(.hidden) {
        opacity: 1;
        height: auto;
      }
      .input-field {
        transition: all 0.2s ease;
      }
      .input-field:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.3);
      }
      .form-container {
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      #toggle-password {
        color: #002244;
      }
      .feedback-card {
        transition: transform 0.2s ease;
      }
      .feedback-card:hover {
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
    <div
      class="form-container max-w-md w-full bg-white rounded-lg shadow-lg p-8"
    >
      <form id="login-form" class="space-y-6" onsubmit="return false;">
        <div class="text-center">
          <span class="text-6xl" role="img" aria-label="Graduation Cap"
            >ðŸŽ“</span
          >
          <h2 class="text-3xl font-bold text-gray-800 mt-2">
            Campus Navigator
          </h2>
          <p class="text-sm text-gray-500 mt-2">
            Sign in or create a student account to get started
          </p>
        </div>
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700"
            >Email</label
          >
          <input
            type="email"
            id="email"
            placeholder="Enter your email"
            required
            class="input-field mt-1 w-full px-4 py-2 border border-gray-300 rounded-md text-gray-900 focus:border-blue-600"
            aria-required="true"
            aria-describedby="email-error"
          />
          <div
            id="email-error"
            class="error-message text-red-600 text-sm hidden"
          ></div>
        </div>
        <div class="relative">
          <label for="password" class="block text-sm font-medium text-gray-700"
            >Password</label
          >
          <input
            type="password"
            id="password"
            placeholder="Enter your password"
            required
            class="input-field mt-1 w-full px-4 py-2 border border-gray-300 rounded-md text-gray-900 focus:border-blue-600"
            aria-required="true"
            aria-describedby="password-error"
          />
          <button
            type="button"
            id="toggle-password"
            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 top-6 hover:text-gray-700"
            aria-label="Toggle password visibility"
          >
            <svg
              id="eye-open"
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
              <path
                fill-rule="evenodd"
                d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"
                clip-rule="evenodd"
              />
            </svg>
            <svg
              id="eye-closed"
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 hidden"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"
                fill-opacity=".5"
              />
              <path
                fill-rule="evenodd"
                d="M1.323 10.323a.75.75 0 010-1.06l7.5-7.5a.75.75 0 011.06 0l7.5 7.5a.75.75 0 11-1.06 1.06L10 3.56 2.383 11.383a.75.75 0 01-1.06-1.06zm0-2.122a.75.75 0 010-1.06l7.5-7.5a.75.75 0 011.06 0l7.5 7.5a.75.75 0 11-1.06 1.06L10 1.439 2.383 9.201a.75.75 0 01-1.06-1.06z"
                clip-rule="evenodd"
                opacity=".5"
              />
              <path
                d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"
                fill-opacity=".5"
              />
              <path
                d="M10 3a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 3zM6.625 5.125a.75.75 0 01.53.22l1.06 1.06a.75.75 0 01-1.06 1.06l-1.06-1.06a.75.75 0 01.53-1.28zm6.75 0a.75.75 0 01.53 1.28l-1.06 1.06a.75.75 0 11-1.06-1.06l1.06-1.06a.75.75 0 01.53-.22z"
                opacity=".5"
              />
            </svg>
          </button>
          <div
            id="password-error"
            class="error-message text-red-600 text-sm hidden"
          ></div>
        </div>
        <!-- <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
          <p class="text-sm text-blue-700 text-center">
            Only students can register here. Staff and admin roles are managed
            through Firebase.
          </p>
        </div> -->
        <div class="space-y-3">
          <button
            type="button"
            id="btn-signup"
            class="btn-primary w-full px-4 py-2 text-white font-semibold rounded-md"
            aria-label="Sign up for a new student account"
          >
            Sign Up (Student)
          </button>
          <button
            type="submit"
            id="btn-login"
            class="btn-primary w-full px-4 py-2 text-white font-semibold rounded-md"
            aria-label="Log in to your account"
          >
            Log In
          </button>
          <button
            type="button"
            id="btn-logout"
            class="btn-primary w-full px-4 py-2 text-white font-semibold rounded-md hidden"
            aria-label="Log out of your account"
          >
            Log Out
          </button>
        </div>
        <div
          id="error-message"
          class="error-message text-red-600 text-sm text-center hidden"
          role="alert"
          aria-live="polite"
        ></div>
      </form>
      <div id="feedback-history" class="mt-6 hidden">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
          Recent Feedback
        </h3>
        <ul id="feedback-list" class="space-y-3"></ul>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        query,
        where,
        orderBy,
        limit,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // TODO: Secure Firebase config (e.g., use backend or reserved hosting URLs)
      const cfg = {
        apiKey: "AIzaSyCnNj7hLoVHMOsTKJ5YulMAr3xF050HwLg",
        authDomain: "mycampus-aeeb6.firebaseapp.com",
        projectId: "mycampus-aeeb6",
        storageBucket: "mycampus-aeeb6.appspot.com",
        messagingSenderId: "365444920677",
        appId: "1:365444920677:web:0d5cdf575fdc1463d01d8c",
        measurementId: "G-BHSMF8KY90",
      };
      const app = initializeApp(cfg);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const emailEl = document.getElementById("email");
      const passEl = document.getElementById("password");
      const btnLogin = document.getElementById("btn-login");
      const btnSignup = document.getElementById("btn-signup");
      const btnLogout = document.getElementById("btn-logout");
      const togglePassword = document.getElementById("toggle-password");
      const errorMessage = document.getElementById("error-message");
      const emailError = document.getElementById("email-error");
      const passwordError = document.getElementById("password-error");
      const loginForm = document.getElementById("login-form");
      const feedbackHistory = document.getElementById("feedback-history");
      const feedbackList = document.getElementById("feedback-list");

      function showError(message, field = null) {
        if (field) {
          const errorEl = document.getElementById(`${field}-error`);
          errorEl.textContent = message;
          errorEl.classList.remove("hidden");
          setTimeout(() => {
            errorEl.classList.add("hidden");
            errorEl.textContent = "";
          }, 5000);
          document.getElementById(field).focus();
        } else {
          errorMessage.textContent = message;
          errorMessage.classList.remove("hidden");
          setTimeout(() => {
            errorMessage.classList.add("hidden");
            errorMessage.textContent = "";
          }, 5000);
        }
      }

      function clearErrors() {
        errorMessage.classList.add("hidden");
        errorMessage.textContent = "";
        emailError.classList.add("hidden");
        emailError.textContent = "";
        passwordError.classList.add("hidden");
        passwordError.textContent = "";
      }

      function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      function validatePassword(password) {
        return password.length >= 6;
      }

      async function loadFeedbackHistory(userId) {
        try {
          const q = query(
            collection(db, "feedback"),
            where("userId", "==", userId),
            orderBy("timestamp", "desc"),
            limit(5)
          );
          const snap = await getDocs(q);
          feedbackList.innerHTML = "";

          if (snap.empty) {
            feedbackList.innerHTML = `
              <li class="text-center text-gray-500 italic">
                No recent feedback
              </li>
            `;
          } else {
            snap.forEach((doc) => {
              const f = doc.data();
              const li = document.createElement("li");
              li.className =
                "feedback-card bg-gray-50 border border-gray-200 rounded-lg p-3";
              li.innerHTML = `
                <div class="font-medium text-gray-800">${f.type}</div>
                <div class="text-sm text-gray-600">${f.feedback}</div>
                <div class="text-xs text-gray-500 mt-1">${new Date(
                  f.timestamp
                ).toLocaleString()}</div>
              `;
              feedbackList.appendChild(li);
            });
          }
          feedbackHistory.classList.remove("hidden");
        } catch (error) {
          console.error("Error loading feedback history:", error);
          showError("Failed to load feedback history.");
        }
      }

      btnSignup.onclick = async () => {
        try {
          clearErrors();
          const email = emailEl.value.trim();
          const password = passEl.value;

          if (!email || !password) {
            showError(
              "Please fill in all fields",
              email ? "password" : "email"
            );
            return;
          }

          if (!validateEmail(email)) {
            showError("Invalid email format", "email");
            return;
          }

          if (!validatePassword(password)) {
            showError("Password must be at least 6 characters", "password");
            return;
          }

          btnSignup.disabled = true;
          btnSignup.textContent = "Signing Up...";

          const { user } = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );

          await setDoc(doc(db, "users", user.uid), {
            role: "student",
            email: email,
            active: true,
            createdAt: new Date().toISOString(),
          });

          alert("Student account created successfully! You can now log in.");
          emailEl.value = "";
          passEl.value = "";
        } catch (e) {
          console.error("Signup error:", e);
          if (e.code === "auth/email-already-in-use") {
            showError(
              "Email already registered. Please log in instead.",
              "email"
            );
          } else if (e.code === "auth/weak-password") {
            showError(
              "Password is too weak. Use at least 6 characters.",
              "password"
            );
          } else if (e.code === "auth/invalid-email") {
            showError("Invalid email address.", "email");
          } else {
            showError("Signup failed: " + e.message);
          }
        } finally {
          btnSignup.disabled = false;
          btnSignup.textContent = "Sign Up (Student)";
        }
      };

      loginForm.onsubmit = async (e) => {
        e.preventDefault();
        try {
          clearErrors();
          const email = emailEl.value.trim();
          const password = passEl.value;

          if (!email || !password) {
            showError(
              "Please fill in all fields",
              email ? "password" : "email"
            );
            return;
          }

          if (!validateEmail(email)) {
            showError("Invalid email format", "email");
            return;
          }

          btnLogin.disabled = true;
          btnLogin.textContent = "Logging In...";
          await signInWithEmailAndPassword(auth, email, password);
        } catch (e) {
          console.error("Login error:", e);
          if (e.code === "auth/user-not-found") {
            showError(
              "User not found. Please check your email or sign up.",
              "email"
            );
          } else if (e.code === "auth/wrong-password") {
            showError("Incorrect password. Please try again.", "password");
          } else if (e.code === "auth/invalid-email") {
            showError("Invalid email address.", "email");
          } else if (e.code === "auth/too-many-requests") {
            showError("Too many failed attempts. Please try again later.");
          } else {
            showError("Login failed: " + e.message);
          }
        } finally {
          btnLogin.disabled = false;
          btnLogin.textContent = "Log In";
        }
      };

      togglePassword.onclick = () => {
        const eyeOpen = document.getElementById("eye-open");
        const eyeClosed = document.getElementById("eye-closed");
        if (passEl.type === "password") {
          passEl.type = "text";
          eyeOpen.classList.add("hidden");
          eyeClosed.classList.remove("hidden");
        } else {
          passEl.type = "password";
          eyeOpen.classList.remove("hidden");
          eyeClosed.classList.add("hidden");
        }
      };

      btnLogout.onclick = async () => {
        try {
          btnLogout.disabled = true;
          btnLogout.textContent = "Logging Out...";
          await signOut(auth);
        } catch (e) {
          console.error("Logout error:", e);
          showError("Logout failed: " + e.message);
        } finally {
          btnLogout.disabled = false;
          btnLogout.textContent = "Log Out";
        }
      };

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          try {
            btnLogin.classList.add("hidden");
            btnSignup.classList.add("hidden");
            btnLogout.classList.remove("hidden");
            emailEl.disabled = true;
            passEl.disabled = true;

            const snap = await getDoc(doc(db, "users", user.uid));

            if (!snap.exists()) {
              showError(
                "User profile not found. Please contact administrator."
              );
              await signOut(auth);
              return;
            }

            const userData = snap.data();
            const role = userData.role;
            const isActive = userData.active !== false;

            if (!isActive) {
              showError(
                "Account is deactivated. Please contact administrator."
              );
              await signOut(auth);
              return;
            }

            await loadFeedbackHistory(user.uid);

            switch (role) {
              case "admin":
                window.location.href = "admin.html";
                break;
              case "staff":
                window.location.href = "staff.html";
                break;
              case "student":
                window.location.href = "student.html";
                break;
              default:
                window.location.href = "student.html";
                break;
            }
          } catch (error) {
            console.error("Auth state change error:", error);
            showError("Authentication error. Please try again.");
            await signOut(auth);
          }
        } else {
          btnLogin.classList.remove("hidden");
          btnSignup.classList.remove("hidden");
          btnLogout.classList.add("hidden");
          emailEl.disabled = false;
          passEl.disabled = false;
          feedbackHistory.classList.add("hidden");
          clearErrors();
        }
      });
    </script>
  </body>
</html>
